{% extends "base.html" %}
{% block content %}
<style>
    .chat-box {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
        background: var(--bg-main);
        display: block; /* Стандартный блок вместо флекса решает проблемы со скроллом */
    }

    .message {
        margin-bottom: 10px;
        padding: 8px 12px;
        border-radius: 12px;
        clear: both;
        max-width: 75%;
        word-wrap: break-word;
        position: relative;
        color: white;
        display: block;
    }

    .sent {
        background: var(--msg-sent);
        float: right;
        border-bottom-right-radius: 2px;
    }

    .received {
        background: var(--msg-received);
        float: left;
        border-bottom-left-radius: 2px;
    }

    .meta {
        font-size: 0.65rem;
        margin-top: 4px;
        opacity: 0.7;
        text-align: right;
    }

    .input-area {
        padding: 10px;
        background: var(--bg-panel);
        display: flex;
        gap: 10px;
        border-top: 1px solid #000;
    }

    #messageInput { margin: 0; flex: 1; }
    .send-btn { width: auto; padding: 0 20px; }
</style>

<div class="chat-box" id="chatBox">
    {% for msg in messages %}
        <div class="message {% if msg.sender_id == current_user.id %}sent{% else %}received{% endif %}">
            {{ msg.body }}
            <div class="meta">{{ msg.timestamp.strftime('%H:%M') }}</div>
        </div>
    {% endfor %}
</div>

<div class="input-area">
    <input type="text" id="messageInput" placeholder="Сообщение..." autocomplete="off">
    <button class="send-btn" onclick="sendMessage()">➤</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    var socket = io();
    var recipient_id = {{ recipient.id }};
    var my_username = "{{ current_user.username }}";

    socket.on('connect', function() {
        socket.emit('join', {recipient_id: recipient_id});
    });

    function sendMessage() {
        var input = document.getElementById("messageInput");
        if (input.value.trim() !== "") {
            socket.emit('send_message', {
                recipient_id: recipient_id, 
                message: input.value
            });
            input.value = ""; 
        }
    }

    socket.on('receive_message', function(data) {
        var chatBox = document.getElementById("chatBox");
        var div = document.createElement("div");
        div.className = "message " + (data.user === my_username ? "sent" : "received");
        div.innerHTML = data.msg + '<div class="meta">' + data.timestamp + '</div>';
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight; 
    });

    // Авто-скролл вниз при загрузке
    var cb = document.getElementById("chatBox");
    cb.scrollTop = cb.scrollHeight;
</script>
{% endblock %}
