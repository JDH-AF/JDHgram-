{% extends "base.html" %}
{% block content %}
<style>
    /* Весь экран чата */
    .chat-wrapper {
        display: flex;
        flex-direction: column;
        height: 100%; /* Занимает весь main-content */
        background: var(--bg-main);
    }

    .chat-header {
        padding: 10px 15px;
        background: var(--bg-panel);
        border-bottom: 1px solid #000;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    #chatBox {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
        display: flex;
        flex-direction: column; /* Сообщения сверху вниз */
        gap: 8px;
    }

    .message {
        padding: 8px 14px;
        border-radius: 16px;
        max-width: 85%;
        word-wrap: break-word;
        color: white;
        font-size: 0.95rem;
        line-height: 1.3;
        position: relative;
    }

    .sent {
        align-self: flex-end;
        background: var(--accent);
        border-bottom-right-radius: 4px;
    }

    .received {
        align-self: flex-start;
        background: #2b3948;
        border-bottom-left-radius: 4px;
    }

    .meta {
        font-size: 0.65rem;
        opacity: 0.7;
        margin-top: 4px;
        text-align: right;
    }

    .input-area {
        padding: 12px;
        background: var(--bg-panel);
        display: flex;
        align-items: center;
        gap: 10px;
        border-top: 1px solid rgba(0,0,0,0.3);
    }

    #messageInput { 
        margin: 0; 
        flex: 1; 
        background: #242f3d;
        border: 1px solid transparent;
        padding: 10px 15px;
        border-radius: 20px;
        color: white;
    }

    .send-btn { 
        width: 44px; height: 44px; 
        border-radius: 50%; 
        padding: 0; 
        display: flex; align-items: center; justify-content: center;
        flex-shrink: 0;
    }
</style>

<div class="chat-wrapper">
    <div class="chat-header">
        <a href="{{ url_for('index') }}" style="text-decoration: none; color: var(--accent); font-size: 1.4rem;">←</a>
        <div>
            <div style="font-weight: bold;">{{ recipient.username }}</div>
            <div style="font-size: 0.7rem; color: var(--text-muted);">JDH-Gram Encryption Active</div>
        </div>
    </div>

    <div id="chatBox">
        {% for msg in messages %}
            <div class="message {% if msg.sender_id == current_user.id %}sent{% else %}received{% endif %}">
                {{ msg.body }}
                <div class="meta">{{ msg.timestamp.strftime('%H:%M') }}</div>
            </div>
        {% endfor %}
    </div>

    <div class="input-area">
        <input type="text" id="messageInput" placeholder="Написать сообщение..." autocomplete="off">
        <button class="send-btn" id="sendBtn">➤</button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    var socket = io({ transports: ['websocket', 'polling'] });
    var recipient_id = {{ recipient.id }};
    var my_username = "{{ current_user.username }}";
    var chatBox = document.getElementById("chatBox");

    socket.on('connect', () => {
        socket.emit('join', {recipient_id: recipient_id});
    });

    function appendMessage(text, type) {
        var now = new Date();
        var time = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
        
        var div = document.createElement("div");
        div.className = "message " + type;
        div.innerHTML = text + '<div class="meta">' + time + '</div>';
        
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function sendMessage() {
        var input = document.getElementById("messageInput");
        var text = input.value.trim();
        if (text !== "") {
            // Отправляем на сервер
            socket.emit('send_message', {
                recipient_id: recipient_id, 
                message: text
            });
            input.value = ""; 
        }
    }

    socket.on('receive_message', function(data) {
        // Если сообщение от меня — оно уже могло быть добавлено (или добавится сейчас)
        // Чтобы не было дублей, если мы решим отрисовывать мгновенно, 
        // пока просто рисуем всё, что пришло от сокета
        var type = (data.user === my_username) ? "sent" : "received";
        appendMessage(data.msg, type);
    });

    document.getElementById("sendBtn").onclick = sendMessage;
    document.getElementById("messageInput").onkeypress = (e) => {
        if (e.key === 'Enter') sendMessage();
    };

    // Скролл в конец при загрузке
    chatBox.scrollTop = chatBox.scrollHeight;
</script>
{% endblock %}
