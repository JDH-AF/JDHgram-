{% extends 'base.html' %}

{% block content %}
<div class="app">
    <!-- HEADER -->
    <header class="header">
        <div class="logo">TG <span class="text-orange">Clone</span></div>
        <div class="user-info">
            <span class="username">{{ current_user.username }}</span>
            <a href="{{ url_for('logout') }}" class="btn btn-sm btn-outline-light">–í—ã–π—Ç–∏</a>
        </div>
    </header>

    <div class="main">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-header">–ß–∞—Ç—ã</div>
            <div class="users-list">
                {% for user in users %}
                <div class="user-item" data-id="{{ user.id }}" data-username="{{ user.username }}">
                    <div class="avatar">üë§</div>
                    <div class="user-name">{{ user.username }}</div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- CHAT AREA -->
        <div class="chat-area">
            <div id="chat-header" class="chat-header">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</div>
            <div id="messages" class="messages"></div>
            <div class="input-area">
                <input type="text" id="message-input" class="form-control bg-secondary text-white border-0" 
                       placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                <button id="send-btn" class="btn btn-orange">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<script>
const socket = io();
let currentRecipient = null;
let currentRoom = null;
const currentUserId = {{ current_user.id | tojson }};

document.querySelectorAll('.user-item').forEach(item => {
    item.addEventListener('click', () => {
        currentRecipient = parseInt(item.dataset.id);
        const username = item.dataset.username;
        
        document.getElementById('chat-header').innerHTML = `
            <div class="chat-user d-flex align-items-center gap-2">
                <div class="avatar">üë§</div>
                <strong>${username}</strong>
            </div>
        `;

        if (currentRoom) socket.emit('leave', {room: currentRoom});
        currentRoom = [currentUserId, currentRecipient].sort().join('_');
        socket.emit('join', {room: currentRoom});

        fetch(`/api/messages/${currentRecipient}`)
            .then(r => r.json())
            .then(msgs => {
                const div = document.getElementById('messages');
                div.innerHTML = '';
                msgs.forEach(m => addMessage(m));
                div.scrollTop = div.scrollHeight;
            });
    });
});

document.getElementById('send-btn').addEventListener('click', sendMessage);
document.getElementById('message-input').addEventListener('keypress', e => {
    if (e.key === 'Enter') sendMessage();
});

function sendMessage() {
    const input = document.getElementById('message-input');
    const text = input.value.trim();
    if (!text || !currentRecipient) return;
    socket.emit('message', { recipient_id: currentRecipient, content: text });
    input.value = '';
}

socket.on('new_message', data => {
    if (parseInt(data.sender_id) === currentRecipient || parseInt(data.sender_id) === currentUserId) {
        addMessage(data);
    }
});

function addMessage(msg) {
    const div = document.getElementById('messages');
    const isMine = parseInt(msg.sender_id) === currentUserId;
    const html = `
        <div class="message ${isMine ? 'mine' : 'theirs'}">
            <div class="message-content">${msg.content}</div>
            <div class="timestamp">${msg.timestamp}</div>
        </div>
    `;
    div.insertAdjacentHTML('beforeend', html);
    div.scrollTop = div.scrollHeight;
}
</script>
{% endblock %}        </div>
    </div>
</div>

<script>
const socket = io();
let currentRecipient = null;
let currentRoom = null;
const currentUserId = {{ current_user.id | tojson }};   // ‚Üê –±–µ–∑–æ–ø–∞—Å–Ω–æ!

document.querySelectorAll('.user-item').forEach(item => {
    item.addEventListener('click', () => {
        currentRecipient = parseInt(item.dataset.id);
        const username = item.dataset.username;
        
        document.getElementById('chat-header').innerHTML = `
            <div class="chat-user">
                <div class="avatar">üë§</div>
                <div><strong>${username}</strong></div>
            </div>
        `;

        if (currentRoom) socket.emit('leave', {room: currentRoom});
        
        currentRoom = [currentUserId, currentRecipient].sort().join('_');
        socket.emit('join', {room: currentRoom});

        fetch(`/api/messages/${currentRecipient}`)
            .then(r => {
                if (!r.ok) throw new Error('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞');
                return r.json();
            })
            .then(msgs => {
                const div = document.getElementById('messages');
                div.innerHTML = '';
                msgs.forEach(m => addMessage(m));
                div.scrollTop = div.scrollHeight;
            })
            .catch(err => console.error(err));
    });
});

document.getElementById('send-btn').addEventListener('click', sendMessage);
document.getElementById('message-input').addEventListener('keypress', e => {
    if (e.key === 'Enter') sendMessage();
});

function sendMessage() {
    const input = document.getElementById('message-input');
    const text = input.value.trim();
    if (!text || !currentRecipient) return;

    socket.emit('message', {
        recipient_id: currentRecipient,
        content: text
    });
    input.value = '';
}

socket.on('new_message', data => {
    if (parseInt(data.sender_id) === currentRecipient || parseInt(data.sender_id) === currentUserId) {
        addMessage(data);
    }
});

function addMessage(msg) {
    const div = document.getElementById('messages');
    const isMine = parseInt(msg.sender_id) === currentUserId;
    const html = `
        <div class="message ${isMine ? 'mine' : 'theirs'}">
            <div class="message-content">${msg.content}</div>
            <div class="timestamp">${msg.timestamp}</div>
        </div>
    `;
    div.insertAdjacentHTML('beforeend', html);
    div.scrollTop = div.scrollHeight;
}
</script>
{% endblock %}
// === –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–Ø ===
function sendMessage() {
    const input = document.getElementById("messageInput");
    const plaintext = input.value.trim();
    if (!plaintext) return;

    // –®–∏—Ñ—Ä—É–µ–º –ø—Ä—è–º–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
    const encrypted = encryptMessage(plaintext, HOMOPHONE_KEY, HOMOPHONE_KEY0);

    socket.emit('send_message', {
        recipient_id: recipient_id,
        message: encrypted
    });

    input.value = "";
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter
document.getElementById("messageInput").addEventListener("keypress", (event) => {
    if (event.key === "Enter") sendMessage();
});

// === –ü–û–õ–£–ß–ï–ù–ò–ï –ù–û–í–û–ì–û –°–û–û–ë–©–ï–ù–ò–Ø ===
socket.on('receive_message', (data) => {
    const decrypted = decryptMessage(data.msg, HOMOPHONE_KEY, HOMOPHONE_KEY0);

    const chatBox = document.getElementById("chatBox");

    const div = document.createElement("div");
    div.className = `message ${data.user === my_username ? "sent" : "received"}`;
    div.innerHTML = `
        <span class="message-text">${decrypted}</span>
        <div class="meta">${data.timestamp}</div>
    `;

    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
});

// === –†–ê–°–®–ò–§–†–û–í–ö–ê –ò–°–¢–û–†–ò–ò –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï ===
window.addEventListener('load', () => {
    document.querySelectorAll('.message').forEach(msgDiv => {
        const encrypted = msgDiv.getAttribute('data-encrypted');
        if (encrypted) {
            const decrypted = decryptMessage(encrypted, HOMOPHONE_KEY, HOMOPHONE_KEY0);
            msgDiv.querySelector('.message-text').textContent = decrypted;
        }
    });

    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑ –ø–æ—Å–ª–µ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏
    const chatBox = document.getElementById("chatBox");
    chatBox.scrollTop = chatBox.scrollHeight;
});
</script>

{% endblock %}
