{% extends "base.html" %}
{% block content %}
<h3>Чат с {{ recipient.username }}</h3>

<div class="chat-box" id="chatBox">
    {% for msg in messages %}
        <div class="message {% if msg.sender_id == current_user.id %}sent{% else %}received{% endif %}">
            {{ msg.body }}
            <div class="meta">{{ msg.timestamp.strftime('%H:%M') }}</div>
        </div>
    {% endfor %}
</div>

<div style="margin-top: 15px; display: flex;">
    <input type="text" id="messageInput" placeholder="Напишите сообщение..." autocomplete="off">
    <button onclick="sendMessage()" style="margin-left: 10px; width: auto;">Отправить</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    var socket = io();
    var recipient_id = {{ recipient.id }};
    var my_username = "{{ current_user.username }}";

    socket.on('connect', function() {
        socket.emit('join', {recipient_id: recipient_id});
    });

    function sendMessage() {
        var input = document.getElementById("messageInput");
        var text = input.value;
        if (text.trim() !== "") {
            socket.emit('send_message', {
                recipient_id: recipient_id, 
                message: text
            });
            input.value = ""; 
        }
    }

    document.getElementById("messageInput").addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            sendMessage();
        }
    });

    socket.on('receive_message', function(data) {
        var chatBox = document.getElementById("chatBox");
        var div = document.createElement("div");
        div.className = "message " + (data.user === my_username ? "sent" : "received");
        div.innerHTML = data.msg + '<div class="meta">' + data.timestamp + '</div>';
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight; 
    });

    var chatBox = document.getElementById("chatBox");
    chatBox.scrollTop = chatBox.scrollHeight;
</script>
{% endblock %}
